<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
    #map canvas {
        cursor: crosshair;
    }
</style>
<div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoidGhlLWluc2lkZS1jb3VwIiwiYSI6ImNqNzllMHcxbzAxNTAzM283dXFydG9hMHYifQ.ePRSr58SxBNKT6HkccO-lw';
var map = new mapboxgl.Map({
    hash: true,
    container: 'map',
    style: 'mapbox://styles/the-inside-coup/cj7ataelv9fib2rqq1mt5yz7o',
    center: [-111.977974, 33.664389],
    zoom: 8.5
});

// Create a popup, but don't add it to the map yet.
var popupMouseClick = new mapboxgl.Popup({
  closeButton: false
});

var popupMouseMove = new mapboxgl.Popup({
  closeButton: false
});

function setHTML(feature) {

    if(!feature.properties.zoneNumber) {
      return;
    }

    // Propser formatting
    html = "<div style=\"font-family: 'Open Sans',sans-serif; display:block; width: 340px; font-size:13px;\">";

    html += "<span style=\"font-size:19px;\">";

    html += feature.properties.name;
    html += "</span>";

    if(feature.properties.image) {
      html += "<br><img width=\"340 px\" src=\"images/";
      html += feature.properties.image;
      html += "\">";
    } else {
      html += "<br><hr>";
    }

    if(feature.properties.zoneName) {
      html += feature.properties.zoneName;
      html += "<br><hr>";
    }

    if(feature.properties.circulation) {
      html += "Average Age: " + feature.properties.averageAge + "<br>";
      html += "Average Income: " + feature.properties.averageIncome + "<br>";
      html += "Average Home Value: " + feature.properties.averageHomeValue + "<br>";
      html += "Zip Codes: " + feature.properties.zipCodes + "<br>";
      html += "Circulation: " + feature.properties.circulation + "<br>";
    }

    if(feature.properties.url) {
      html += "<br><br><a target=\"_blank\" style=\"color:#F6863A; text-decoration:none;\" href=\"";
      html += feature.properties.url;
      html += "\">";
      html += "<i>Click here for more details</i></a>";
    }

    html += "</div>";

    console.log(html);
    return html;
}

function updatePopup(e) {

  var features = map.queryRenderedFeatures(e.point);

  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = features.length ? "pointer" : "";


  // if Popup is open, meaning it has been clicked, then exit
  if(popupMouseClick.isOpen()){
    return;
  }

  // Remove things if no feature was found.
  if (!features.length) {
    popupMouseMove.remove();
    return;
  }

  // clear existing
  popupMouseMove.remove();

  // Single out the first found feature on mouseove.
  var feature = features[0];

  // Populate the popup and set its coordinates
  // based on the feature found.
  var html = setHTML(feature);

  if(html) {
    popupMouseMove
    .setLngLat(e.lngLat)
    .setHTML(html)
    .addTo(map);
  }
};

map.on("mousemove", function(e) {
  // updatePopup(e);
});

map.on("click", function(e) {

  var features = map.queryRenderedFeatures(e.point);

  // Remove things if no feature was found.
  if (!features.length) {
    return;
  }

  var feature = features[0];

  var html = setHTML(feature);
  if(html) {
    popupMouseClick = new mapboxgl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(html)
                .addTo(map);
  }
});
</script>

</body>
</html>
